<script>
    let allVideos = [];
    let currentCategory = 'all';
    let isVideoPlaying = false; // Track video playback state

    // Enhanced video data with categories and durations
    const videoData = [
      {
        "title": "Indian Girl viral",
        "thumbnail": "https://files.catbox.moe/jkpyvz.png",
        "url": "https://files.catbox.moe/sjftxq.mp4"
      },
      {
        "title": "Bhabhi In heat",
        "thumbnail": "https://files.catbox.moe/qr6l56.png",
        "url": "https://files.catbox.moe/4mamfo.mp4"
      },
      {
        "title": "Cute girl big boobs",
        "thumbnail": "https://files.catbox.moe/qq912z.png",
        "url": "https://files.catbox.moe/nqquuv.mp4"
      }
    ];

    // Try to fetch from videos.json, fallback to embedded data
    fetch('videos.json')
      .then(res => res.json())
      .then(data => {
        allVideos = data.map(video => ({
          ...video,
          category: video.category || 'movies',
          duration: video.duration || '2:00'
        }));
        renderVideos();
      })
      .catch(() => {
        // Fallback to embedded data if videos.json doesn't exist
        allVideos = videoData;
        renderVideos();
      });

    function renderVideos() {
      const grid = document.getElementById('videoGrid');
      const filteredVideos = currentCategory === 'all' 
        ? allVideos 
        : allVideos.filter(video => video.category === currentCategory);

      grid.innerHTML = '';

      filteredVideos.forEach(video => {
        const card = document.createElement('div');
        card.className = 'video-card';
        card.innerHTML = `
          <div class="video-thumbnail">
            <img src="${video.thumbnail}" alt="${video.title}" loading="lazy">
            <div class="video-duration">${video.duration}</div>
          </div>
          <div class="video-info">
            <div class="video-category">${video.category.toUpperCase()}</div>
            <h3 class="video-title">${video.title}</h3>
          </div>
        `;
        card.onclick = () => playVideo(video.url);
        grid.appendChild(card);
      });
    }

    function playVideo(url) {
      const container = document.getElementById('playerContainer');
      container.style.display = 'flex';
      document.getElementById('my-video').src = url;
      fluidPlayer("my-video", { layoutControls: { fillToContainer: true } });
      
      // Push state to history when video plays
      history.pushState({ videoPlaying: true }, '');
      isVideoPlaying = true;
    }

    // Handle back button press
    window.addEventListener('popstate', function(event) {
      if (isVideoPlaying) {
        closeVideoPlayer();
        // Push another state to prevent exiting
        if (event.state && event.state.videoPlaying) {
          history.pushState(null, '', window.location.pathname);
        }
      }
    });

    function closeVideoPlayer() {
      const container = document.getElementById('playerContainer');
      container.style.display = 'none';
      const video = document.getElementById('my-video');
      video.pause();
      video.src = '';
      isVideoPlaying = false;
    }

    // Category filtering
    document.querySelectorAll('.category').forEach(category => {
      category.addEventListener('click', (e) => {
        e.preventDefault();
        
        // Update active category
        document.querySelectorAll('.category').forEach(c => c.classList.remove('active'));
        category.classList.add('active');
        
        // Update current category and render
        currentCategory = category.dataset.category;
        renderVideos();
      });
    });

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filteredVideos = allVideos.filter(video => 
        video.title.toLowerCase().includes(searchTerm)
      );
      
      const grid = document.getElementById('videoGrid');
      grid.innerHTML = '';

      filteredVideos.forEach(video => {
        const card = document.createElement('div');
        card.className = 'video-card';
        card.innerHTML = `
          <div class="video-thumbnail">
            <img src="${video.thumbnail}" alt="${video.title}" loading="lazy">
            <div class="video-duration">${video.duration}</div>
          </div>
          <div class="video-info">
            <div class="video-category">${video.category.toUpperCase()}</div>
            <h3 class="video-title">${video.title}</h3>
          </div>
        `;
        card.onclick = () => playVideo(video.url);
        grid.appendChild(card);
      });
    });

    // Close player modal
    document.getElementById('playerContainer').onclick = function(e) {
      if (e.target === this) {
        closeVideoPlayer();
        // Update history when closing manually
        if (window.history.state && window.history.state.videoPlaying) {
          history.back();
        }
      }
    };
  </script>
